"use strict";(self.webpackChunkdrasti_teacher_dashboard=self.webpackChunkdrasti_teacher_dashboard||[]).push([[359],{8359:(It,I,p)=>{p.r(I),p.d(I,{ChattingModule:()=>wt});var g=p(9808),y=p(2729),t=p(5e3),S=p(507),M=p(5861),k=p(259),f=p(1591),N=p(9547),T=p(2313),B=p(2290),D=p(377),J=p(1762),U=p(2340),A=p(520);let H=(()=>{class o{constructor(e){this.http=e}addAnswer(e){return this.http.post(`${U.N.apiUrl}add_answer`,e)}}return o.\u0275fac=function(e){return new(e||o)(t.LFG(A.eN))},o.\u0275prov=t.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"}),o})();function R(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"button",5),t.NdJ("click",function(){return t.CHM(e),t.oxw().cancelREcord()}),t._UZ(1,"i",6),t.qZA()}}function O(o,s){1&o&&t._UZ(0,"span",7)}function F(o,s){if(1&o&&(t.TgZ(0,"p",13)(1,"span",14)(2,"span"),t._uU(3),t.ALo(4,"number"),t.qZA()()()),2&o){const e=t.oxw(2);t.xp6(3),t.AsE("",e.recordTime,":",t.xi3(4,2,e.recordSeconds,"2.0"),"")}}function Q(o,s){1&o&&t._UZ(0,"span",7)}function Y(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"i",15),t.NdJ("click",function(){return t.CHM(e),t.oxw(2).startRecording()}),t.qZA()}}function P(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"i",16),t.NdJ("click",function(){return t.CHM(e),t.oxw(2).pauseRecording()}),t.qZA()}}function j(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"i",17),t.NdJ("click",function(){return t.CHM(e),t.oxw(2).resumeRecording()}),t.qZA()}}function E(o,s){if(1&o&&(t.ynx(0),t.YNc(1,F,5,5,"p",8),t.YNc(2,Q,1,0,"span",2),t.TgZ(3,"button",9),t.YNc(4,Y,1,0,"i",10),t.YNc(5,P,1,0,"i",11),t.YNc(6,j,1,0,"i",12),t.qZA(),t.BQk()),2&o){const e=t.oxw();t.xp6(1),t.Q6J("ngIf",0!=e.recordingStatus),t.xp6(1),t.Q6J("ngIf",0!=e.recordingStatus),t.xp6(2),t.Q6J("ngIf",0==e.recordingStatus),t.xp6(1),t.Q6J("ngIf",0!=e.recordingStatus&&!e.paused),t.xp6(1),t.Q6J("ngIf",0!=e.recordingStatus&&e.paused)}}function q(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"div",18),t.NdJ("click",function(){return t.CHM(e),t.oxw().stopRecording()}),t._UZ(1,"i",19),t.qZA()}}let L=(()=>{class o{constructor(e){this.cdr=e,this.recording=!1,this.audioChunks=[],this.paused=!1,this.nowRecording=new t.vpe,this.send=new t.vpe,this.micError=new t.vpe,this.recordingStatus=0,this.hideOptions=!1,this.recordTime=0,this.time=0,this.recordSeconds=0,this.cancel=!1}startRecording(){this.recordingStatus=1,this.time=0,this.nowRecording.emit(!0),navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{this.mediaRecorder=new MediaRecorder(e),this.mediaRecorder.start(),this.mediaStream=e,this.hideOptions=!1,this.recording=!0,this.interval=setInterval(()=>{this.time+=1,60==this.recordSeconds?(this.recordSeconds=0,this.recordTime+=1):this.recordSeconds+=1},1e3),this.mediaRecorder.ondataavailable=n=>{this.audioChunks.push(n.data)},this.mediaRecorder.onstop=()=>{if(this.recording){this.recording=!1;const n=new Blob(this.audioChunks,{type:"audio/webm"});this.audioChunks=[],this.send.emit({audio:n,duration:this.time}),this.audioChunks=[]}this.stopMediaStream()}}).catch(e=>{this.recordingStatus=0,this.nowRecording.emit(!1),this.micError.emit(!0)})}pauseRecording(){this.mediaRecorder&&"recording"===this.mediaRecorder.state&&(clearInterval(this.interval),this.mediaRecorder.pause(),this.paused=!0)}resumeRecording(){this.mediaRecorder&&"paused"===this.mediaRecorder.state&&(this.interval=setInterval(()=>{this.time+=1,60==this.recordSeconds?(this.recordSeconds=0,this.recordTime+=1):this.recordSeconds+=1},1e3),this.mediaRecorder.resume(),this.paused=!1)}stopRecording(){this.mediaRecorder&&this.recording&&(clearInterval(this.interval),this.recordTime=0,this.recordSeconds=0,this.mediaRecorder.stop(),this.paused=!1,this.recordingStatus=0,this.nowRecording.emit(!1))}convertBlobToBase64(e){return new Promise((n,i)=>{const a=new FileReader;a.readAsDataURL(e),a.onloadend=()=>{n(a.result)},a.onerror=i})}cancelREcord(){this.recording=!1,this.audioChunks=[],this.audioUrl="",this.paused=!1,this.nowRecording.emit(!1),this.recordingStatus=0,this.recordTime=0,this.recordSeconds=0,this.cdr.detectChanges(),this.stopMediaStream(),this.interval&&clearInterval(this.interval)}stopMediaStream(){this.mediaStream&&this.mediaStream.getTracks().forEach(e=>e.stop())}ngOnDestroy(){this.stopMediaStream()}}return o.\u0275fac=function(e){return new(e||o)(t.Y36(t.sBO))},o.\u0275cmp=t.Xpm({type:o,selectors:[["app-audio-message"]],inputs:{cancel:"cancel"},outputs:{nowRecording:"nowRecording",send:"send",micError:"micError"},decls:5,vars:4,consts:[[1,"d-flex","align-items-center","justify-content-end","w-100"],["class","recordbtn",3,"click",4,"ngIf"],["class","mx-2",4,"ngIf"],[4,"ngIf"],["class","whit mx-2",3,"click",4,"ngIf"],[1,"recordbtn",3,"click"],[1,"fa-solid","fa-trash-can","icnColor"],[1,"mx-2"],["style","min-width: 100px","class","m-0",4,"ngIf"],[1,"recordbtn"],["class","fa-solid fa-microphone icnColor",3,"click",4,"ngIf"],["class","fa-regular fa-circle-pause redcolor",3,"click",4,"ngIf"],["class","fa-solid fa-microphone redcolor",3,"click",4,"ngIf"],[1,"m-0",2,"min-width","100px"],[2,"min-width","30px","display","inline-block"],[1,"fa-solid","fa-microphone","icnColor",3,"click"],[1,"fa-regular","fa-circle-pause","redcolor",3,"click"],[1,"fa-solid","fa-microphone","redcolor",3,"click"],[1,"whit","mx-2",3,"click"],[1,"fa-solid","fa-paper-plane"]],template:function(e,n){1&e&&(t.TgZ(0,"div",0),t.YNc(1,R,2,0,"button",1),t.YNc(2,O,1,0,"span",2),t.YNc(3,E,7,5,"ng-container",3),t.YNc(4,q,2,0,"div",4),t.qZA()),2&e&&(t.xp6(1),t.Q6J("ngIf",0!=n.recordingStatus),t.xp6(1),t.Q6J("ngIf",0!=n.recordingStatus),t.xp6(1),t.Q6J("ngIf",!n.hideOptions),t.xp6(1),t.Q6J("ngIf",0!=n.recordingStatus))},directives:[g.O5],pipes:[g.JJ],styles:[".recordbtn[_ngcontent-%COMP%]{background-color:transparent!important;padding:0!important;border:none}.icnColor[_ngcontent-%COMP%]{color:#920f11!important;font-size:1.3rem}.redcolor[_ngcontent-%COMP%]{font-size:1.3rem;color:red}.whit[_ngcontent-%COMP%]{cursor:pointer;background-color:#920f11;width:2rem;height:2rem;border-radius:50%;display:flex;justify-content:center;align-items:center}.whit[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:1rem;color:#fff}.gry[_ngcontent-%COMP%]{vertical-align:middle;font-size:2rem;color:#d8d3d3}"]}),o})();const $=["boxchat2"],z=function(o,s){return{background:o,color:s}};function W(o,s){if(1&o&&(t.TgZ(0,"span",18),t._uU(1),t.qZA()),2&o){const e=t.oxw().$implicit,n=t.oxw();t.Q6J("ngStyle",t.WLB(2,z,n.userid==(null==e?null:e.from_id)||"_1"==(null==e?null:e.from_id)||e.from_display_name?"#920f11":"#e4e6eb",n.userid==(null==e?null:e.from_id)||"_1"==(null==e?null:e.from_id)||e.from_display_name?"white":"black")),t.xp6(1),t.hij(" ",null==e?null:e.message_content," ")}}const Z=function(o){return{"text-align":o}};function G(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"div",19),t.NdJ("click",function(){t.CHM(e);const i=t.oxw().$implicit;return t.oxw().currentImage=null==i?null:i.message_content}),t._UZ(1,"img",20),t.qZA()}if(2&o){const e=t.oxw().$implicit,n=t.oxw();t.Q6J("ngStyle",t.VKq(2,Z,n.userid==(null==e?null:e.from_id)||"_1"==(null==e?null:e.from_id)||e.from_display_name?"right":"left")),t.xp6(1),t.Q6J("src",null==e?null:e.message_content,t.LSH)}}function V(o,s){1&o&&t._UZ(0,"i",28)}const K=function(o){return{"justify-content":o}};function X(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"div",21),t.YNc(1,V,1,0,"i",22),t._UZ(2,"i",23,24),t.TgZ(4,"audio",25,26),t.NdJ("play",function(){t.CHM(e);const i=t.MAs(5);return t.oxw(2).onAudioPlay(i)})("canplaythrough",function(){t.CHM(e);const i=t.MAs(3),a=t.MAs(5);return i.style.display="none",a.style.display="block"}),t._UZ(6,"source",27),t._uU(7," Your browser does not support the audio element. "),t.qZA()()}if(2&o){const e=t.oxw().$implicit,n=t.oxw();t.Q6J("ngStyle",t.VKq(3,K,n.userid==(null==e?null:e.from_id)||"_1"==(null==e?null:e.from_id)||e.from_display_name?"flex-start":"flex-end")),t.xp6(1),t.Q6J("ngIf",null==e?null:e.isUploading),t.xp6(5),t.Q6J("src",n.getSafeUrl(null==e?null:e.message_content),t.LSH)}}function tt(o,s){if(1&o&&(t.TgZ(0,"p",29),t._uU(1),t.TgZ(2,"bdi",30),t._uU(3),t.ALo(4,"date"),t.qZA()()),2&o){const e=t.oxw().$implicit;t.xp6(1),t.hij(" \u0645\u0646 ",null==e?null:e.from," - "),t.xp6(2),t.Oqu(t.xi3(4,2,null==e?null:e.date,"d MMMM, h:mm a"))}}function et(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"p",31)(1,"i",32),t.NdJ("click",function(){t.CHM(e);const i=t.oxw().$implicit;return t.oxw().selectedMsgToDelete=i}),t.qZA(),t.TgZ(2,"bdi",33),t._uU(3),t.ALo(4,"date"),t.qZA()()}if(2&o){const e=t.oxw().$implicit;t.xp6(3),t.hij("",t.xi3(4,1,null==e?null:e.date,"d MMMM, h:mm a")," ")}}function nt(o,s){if(1&o&&(t.TgZ(0,"li",12),t.YNc(1,W,2,5,"span",13),t.YNc(2,G,2,4,"div",14),t.YNc(3,X,8,5,"div",15),t.YNc(4,tt,5,5,"p",16),t.YNc(5,et,5,4,"p",17),t.qZA()),2&o){const e=s.$implicit,n=t.oxw();t.Q6J("ngStyle",t.VKq(6,Z,n.userid==(null==e?null:e.from_id)||"_1"==(null==e?null:e.from_id)||e.from_display_name?"right":"left")),t.xp6(1),t.Q6J("ngIf","text"==(null==e?null:e.type)),t.xp6(1),t.Q6J("ngIf","photo"==(null==e?null:e.type)),t.xp6(1),t.Q6J("ngIf","audio"==(null==e?null:e.type)),t.xp6(1),t.Q6J("ngIf",n.userid!=(null==e?null:e.from_id)&&"_1"!=(null==e?null:e.from_id)&&!e.from_display_name),t.xp6(1),t.Q6J("ngIf",n.userid==(null==e?null:e.from_id)||"_1"==(null==e?null:e.from_id)||e.from_display_name)}}function ot(o,s){1&o&&(t.TgZ(0,"li")(1,"div",34)(2,"div",35),t._UZ(3,"div")(4,"div")(5,"div")(6,"div"),t.qZA()()())}function it(o,s){if(1&o){const e=t.EpF();t.ynx(0),t.TgZ(1,"app-audio-message",36),t.NdJ("micError",function(){return t.CHM(e),t.oxw().micrphonAlert=!0})("send",function(i){t.CHM(e);const a=t.oxw();return a.loading(),a.sendAudio(i)})("nowRecording",function(i){return t.CHM(e),t.oxw().nowRecording=i}),t.qZA(),t.BQk()}}function st(o,s){if(1&o){const e=t.EpF();t.ynx(0),t.TgZ(1,"div",37),t._UZ(2,"i",38),t.TgZ(3,"input",39),t.NdJ("input",function(i){return t.CHM(e),t.oxw().onImageChange(i)}),t.qZA()(),t.TgZ(4,"input",40,41),t.NdJ("keyup.enter",function(){t.CHM(e);const i=t.MAs(5);return t.oxw().sendMessage(i)}),t.qZA(),t.TgZ(6,"i",42),t.NdJ("click",function(){t.CHM(e);const i=t.MAs(5);return t.oxw().sendMessage(i)}),t.qZA(),t.BQk()}}function at(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"div",43)(1,"div",44)(2,"h2"),t._uU(3,"\u0627\u0644\u0633\u0645\u0627\u062d \u0644\u0644\u0645\u064a\u0643\u0631\u0648\u0641\u0648\u0646"),t.qZA(),t.TgZ(4,"p"),t._uU(5," \u0644\u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u0631\u0633\u0627\u0626\u0644 \u0627\u0644\u0635\u0648\u062a\u064a\u0629\u060c \u0646\u062d\u062a\u0627\u062c \u0625\u0644\u0649 \u0627\u0644\u0648\u0635\u0648\u0644 \u0625\u0644\u0649 \u0627\u0644\u0645\u064a\u0643\u0631\u0648\u0641\u0648\u0646 \u0627\u0644\u062e\u0627\u0635 \u0628\u0643. \u0627\u0646\u0642\u0631 \u0641\u0648\u0642 \u0634\u0631\u064a\u0637 URL \u0648\u0627\u062e\u062a\u0631 \u0627\u0644\u0633\u0645\u0627\u062d \u062f\u0627\u0626\u0645\u064b\u0627 \u0628\u0627\u0644\u0648\u0635\u0648\u0644 \u0625\u0644\u0649 \u0627\u0644\u0645\u064a\u0643\u0631\u0648\u0641\u0648\u0646 \u0627\u0644\u062e\u0627\u0635 \u0628\u0643. "),t.qZA(),t.TgZ(6,"div",45)(7,"button",46),t.NdJ("click",function(){return t.CHM(e),t.oxw().micrphonAlert=!1}),t._uU(8," \u062d\u0633\u0646\u0627\u064b "),t.qZA()()()()}}function rt(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"div",47)(1,"div",48)(2,"div",49)(3,"i",50),t.NdJ("click",function(){return t.CHM(e),t.oxw().currentImage=""}),t.qZA()(),t._UZ(4,"img",51),t.qZA()()}if(2&o){const e=t.oxw();t.xp6(4),t.Q6J("src",e.currentImage,t.LSH)}}function lt(o,s){1&o&&t._UZ(0,"i",23)}function ct(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"div",52)(1,"div",53)(2,"p"),t._uU(3,"\u062a\u0623\u0643\u064a\u062f \u062d\u0630\u0641 \u0627\u0644\u0631\u0633\u0627\u0644\u0629 \u061f"),t.qZA(),t.TgZ(4,"div",54)(5,"button",55),t.NdJ("click",function(){t.CHM(e);const i=t.oxw();return i.deleteMessage(i.selectedMsgToDelete)}),t.YNc(6,lt,1,0,"i",56),t._uU(7," \u062d\u0630\u0641 "),t.qZA(),t.TgZ(8,"button",57),t.NdJ("click",function(){return t.CHM(e),t.oxw().selectedMsgToDelete=""}),t._uU(9," \u0627\u0644\u063a\u0627\u0621 "),t.qZA()()()()}if(2&o){const e=t.oxw();t.xp6(5),t.Q6J("disabled",e.deleteMsgLoading),t.xp6(1),t.Q6J("ngIf",e.deleteMsgLoading)}}(0,g.qS)(N.Z);let dt=(()=>{class o{constructor(e,n,i,a,l,u,r,_){this.sanitizer=e,this.toastr=n,this.angularFireStore=i,this.datepipe=a,this.afs=l,this.title=u,this.http=r,this.cd=_,this.currentAudio=null,this.imageLoading=!1,this.selectedMsgToDelete="",this.currentImage="",this.micrphonAlert=!1,this.nowRecording=!1,this.showaudio=!0,this.messages=[],this.studentName="",this.closeChat=new t.vpe,this.localMsgs=[],this.deleteMsgLoading=!1}ngOnChanges(e){this.messages=[...this.messages,...this.localMsgs],this.messages=this.messages.sort(function(n,i){return new Date(n.date)-new Date(i.date)}),console.log(this.messages),this.cd.detectChanges(),this.scrollChatBox()}getSafeUrl(e){return this.sanitizer.bypassSecurityTrustUrl(e)}scrollChatBox(){setTimeout(()=>{this.boxchat&&(this.boxchat.nativeElement.scrollTop=this.boxchat.nativeElement.scrollHeight)},10)}ngAfterViewInit(){}onImageChange(e){var n;const i=e.target;if(!i.files||0===i.files.length)return void this.toastr.error("\u0644\u0645 \u064a\u062a\u0645 \u0627\u062e\u062a\u064a\u0627\u0631 \u0623\u064a \u0645\u0644\u0641");const a=i.files[0];if(!a.type.startsWith("image/"))return void this.toastr.error("\u0627\u0644\u0645\u0644\u0641 \u0627\u0644\u0645\u062d\u062f\u062f \u0644\u064a\u0633 \u0635\u0648\u0631\u0629!");if(a.size>52428800)return void this.toastr.error("\u062d\u062c\u0645 \u0627\u0644\u0635\u0648\u0631\u0629 \u064a\u062c\u0628 \u0623\u0644\u0627 \u064a\u062a\u062c\u0627\u0648\u0632 50 \u0645\u064a\u062c\u0627");const u=null===(n=null==e?void 0:e.target)||void 0===n?void 0:n.files[0];let r=this.angularFireStore.ref(`message_images/photo_message_${this.datepipe.transform(new Date,"yyyy-MM-dd HH:mm:ss")}`);this.imageLoading=!0,this.scrollChatBox(),r.put(u).then(()=>{r.getDownloadURL().subscribe(_=>{var m,h,d,c,x;let C=new Date;(0,f.t8)((0,f.iH)(this.db,`Subjects-Messages/${null===(m=this.studentDetails)||void 0===m?void 0:m.materialId}/${null===(h=this.studentDetails)||void 0===h?void 0:h.studentId}/${this.afs.createId()}`),{date:this.datepipe.transform(C,"yyyy-MM-dd HH:mm:ss"),did_read:!1,from:localStorage.getItem("username"),from_display_name:localStorage.getItem("name_in_web"),from_number:localStorage.getItem("userphone"),from_id:localStorage.getItem("userid"),message_content:_,material_name:null===(d=this.studentDetails)||void 0===d?void 0:d.materialName,to:null===(c=this.studentDetails)||void 0===c?void 0:c.studentName,to_id:`${null===(x=this.studentDetails)||void 0===x?void 0:x.studentId}`,type:"photo"}).then(()=>{this.http.addAnswer({material_id:this.studentDetails.materialId,answer:"\u0635\u0648\u0631\u0629",student_id:this.studentDetails.studentId}).subscribe(),console.log("cancel"),this.imageLoading=!1,this.scrollChatBox()}),this.scrollChatBox()})})}loading(){}sendAudio(e){var n=this;return(0,M.Z)(function*(){var i,a,l;n.nowRecording=!1;let u=new Date;const r="local-"+Date.now(),_=URL.createObjectURL(e.audio);n.localMsgs.push({date:n.datepipe.transform(u,"yyyy-MM-dd HH:mm:ss"),id:r,message_content:_,duration:e.duration,isUploading:!0,did_read:!1,from:localStorage.getItem("username"),from_display_name:localStorage.getItem("name_in_web"),from_number:localStorage.getItem("userphone"),from_id:localStorage.getItem("userid"),material_name:null===(i=n.studentDetails)||void 0===i?void 0:i.materialName,to:null===(a=n.studentDetails)||void 0===a?void 0:a.studentName,to_id:`${null===(l=n.studentDetails)||void 0===l?void 0:l.studentId}`,type:"audio"}),n.messages=[...n.messages,...n.localMsgs],n.messages=n.messages.sort(function(d,c){return new Date(d.date)-new Date(c.date)}),n.scrollChatBox(),n.cd.detectChanges(),n.scrollChatBox();let m=n.angularFireStore.ref(`message_images/voice_message_${n.datepipe.transform(new Date,"yyyy-MM-dd HH:mm:ss")}.wav`);n.scrollChatBox();const h=yield n.convertToWav(e.audio);m.put(h).then(()=>{m.getDownloadURL().subscribe(d=>{var c,x,C,v,b;console.log(d),(0,f.t8)((0,f.iH)(n.db,`Subjects-Messages/${null===(c=n.studentDetails)||void 0===c?void 0:c.materialId}/${null===(x=n.studentDetails)||void 0===x?void 0:x.studentId}/${n.afs.createId()}`),{date:n.datepipe.transform(u,"yyyy-MM-dd HH:mm:ss"),did_read:!1,duration:`${e.duration}`,from:localStorage.getItem("username"),from_display_name:localStorage.getItem("name_in_web"),from_number:localStorage.getItem("userphone"),from_id:localStorage.getItem("userid"),message_content:d,material_name:null===(C=n.studentDetails)||void 0===C?void 0:C.materialName,to:null===(v=n.studentDetails)||void 0===v?void 0:v.studentName,to_id:`${null===(b=n.studentDetails)||void 0===b?void 0:b.studentId}`,type:"audio"}).then(()=>{n.http.addAnswer({material_id:n.studentDetails.materialId,answer:"\u0631\u0633\u0627\u0644\u0629 \u0635\u0648\u062a\u064a\u0629",student_id:n.studentDetails.studentId}).subscribe(),console.log(r),n.messages=n.messages.filter(w=>w.id!==r),n.localMsgs=n.localMsgs.filter(w=>w.id!==r),n.imageLoading=!1}),n.scrollChatBox()})})})()}ngOnInit(){const n=(0,k.ZF)({apiKey:"AIzaSyCrZO0tF5O5Ms8au460-tmGbNS3mJ6QrEc",authDomain:"drasti-37a06.firebaseapp.com",databaseURL:"https://drasti-37a06-default-rtdb.firebaseio.com",projectId:"drasti-37a06",storageBucket:"drasti-37a06.appspot.com",messagingSenderId:"850147128578",appId:"1:850147128578:web:2153add74417b85d4fbe1b",measurementId:"G-41JEDDFQT2"});this.db=(0,f.N8)(n),window.scroll(0,0),this.title.setTitle("NAMNAM"),this.messages=this.messages.sort(function(a,l){return new Date(a.date)-new Date(l.date)}),console.log(this.messages);let i=this.messages.find(a=>a.from_id!=localStorage.getItem("userid")&&"_1"!=a.from_id&&!a.from_display_name);this.studentDetails={studentName:i.from,studentId:i.from_id,materialName:i.to,materialId:i.to_id}}sendMessage(e){var n,i,a,l,u;let r=e.value;if(r.toString().trim().length>0){let _=new Date;console.log(this.studentDetails),(0,f.t8)((0,f.iH)(this.db,`Subjects-Messages/${null===(n=this.studentDetails)||void 0===n?void 0:n.materialId}/${null===(i=this.studentDetails)||void 0===i?void 0:i.studentId}/${this.afs.createId()}`),{did_read:!1,date:this.datepipe.transform(_,"yyyy-MM-dd HH:mm:ss"),from:localStorage.getItem("username"),from_display_name:localStorage.getItem("name_in_web"),from_number:localStorage.getItem("userphone"),from_id:localStorage.getItem("userid"),message_content:r,material_name:null===(a=this.studentDetails)||void 0===a?void 0:a.materialName,to:null===(l=this.studentDetails)||void 0===l?void 0:l.studentName,to_id:`${null===(u=this.studentDetails)||void 0===u?void 0:u.studentId}`,type:"text"}).then(()=>{this.http.addAnswer({material_id:this.studentDetails.materialId,answer:r,student_id:this.studentDetails.studentId}).subscribe()}),e.value="",this.scrollChatBox()}}get userid(){return localStorage.getItem("userid")}downloadImage(){fetch(this.currentImage).then(e=>e.blob()).then(e=>{const n=window.URL.createObjectURL(e),i=document.createElement("a");i.href=n,i.download="downloaded-image.png",i.click(),URL.revokeObjectURL(n)}).catch(e=>console.error("Download failed:",e))}onEscape(e){this.currentImage=""}onAudioPlay(e){this.currentAudio&&this.currentAudio!==e&&(this.currentAudio.pause(),this.currentAudio.currentTime=0),this.currentAudio=e}convertToWav(e){var n=this;return(0,M.Z)(function*(){const i=new AudioContext,a=yield e.arrayBuffer(),l=yield i.decodeAudioData(a),u=n.audioBufferToWav(l);return new Blob([u],{type:"audio/wav"})})()}audioBufferToWav(e){const n=e.numberOfChannels,i=e.length*n*2+44,a=new ArrayBuffer(i),l=new DataView(a),u=[];let r,_=0,m=0;d(1179011410),d(i-8),d(1163280727),d(544501094),d(16),h(1),h(n),d(e.sampleRate),d(2*e.sampleRate*n),h(2*n),h(16),d(1635017060),d(i-m-4);for(let c=0;c<e.numberOfChannels;c++)u.push(e.getChannelData(c));for(;m<i;){for(let c=0;c<n;c++)r=Math.max(-1,Math.min(1,u[c][_])),r=r<0?32768*r:32767*r,l.setInt16(m,r,!0),m+=2;_++}return a;function h(c){l.setUint16(m,c,!0),m+=2}function d(c){l.setUint32(m,c,!0),m+=4}}deleteMessage(e){if(!this.studentDetails.materialId||!this.studentDetails.studentId||!e.key)return void console.log("s");this.deleteMsgLoading=!0;const n=(0,f.iH)(this.db,`Subjects-Messages/${this.studentDetails.materialId}/${this.studentDetails.studentId}/${e.key}`);(0,f.Od)(n).then(()=>{console.log("Message deleted successfully"),this.selectedMsgToDelete="",this.deleteMsgLoading=!1}).catch(i=>{this.deleteMsgLoading=!1,console.error("Error deleting message:",i)})}}return o.\u0275fac=function(e){return new(e||o)(t.Y36(T.H7),t.Y36(B._W),t.Y36(D.Q1),t.Y36(g.uU),t.Y36(J.ST),t.Y36(T.Dx),t.Y36(H),t.Y36(t.sBO))},o.\u0275cmp=t.Xpm({type:o,selectors:[["app-chat-box"]],viewQuery:function(e,n){if(1&e&&t.Gf($,5),2&e){let i;t.iGM(i=t.CRH())&&(n.boxchat=i.first)}},hostBindings:function(e,n){1&e&&t.NdJ("keydown.escape",function(a){return n.onEscape(a)},!1,t.evT)},inputs:{messages:"messages",studentName:"studentName"},outputs:{closeChat:"closeChat"},features:[t._Bn([{provide:t.soG,useValue:"ar"}]),t.TTD],decls:15,vars:8,consts:[[1,"chatbox"],[1,"header","px-3","py-2","d-flex","align-items-center","justify-content-between",2,"border-bottom","1px solid #cfcfcf"],[1,"fw-bold"],[1,"body"],["boxchat2",""],[1,"p-2","list-unstyled","m-0"],["class","mb-2",3,"ngStyle",4,"ngFor","ngForOf"],[4,"ngIf"],[1,"footer","p-2","d-flex","align-items-center","justify-content-between",2,"border-top","1px solid #cfcfcf","gap","10px"],["style","display: flex; justify-content: center; align-items: center","class","locationPopup",4,"ngIf"],["style","\n    position: fixed;\n    top: 0;\n    bottom: 0;\n    right: 0;\n    left: 0;\n    background-color: black;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    height: 100vh;\n  ",4,"ngIf"],["style","\n    position: fixed;\n    top: 0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    background-color: rgba(0, 0, 0, 0.5);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n  ","class","delete-popup",4,"ngIf"],[1,"mb-2",3,"ngStyle"],["style","\n            border-radius: 15px;\n            padding: 10px;\n            display: inline-block;\n            max-width: 80%;\n            word-break: break-word;\n          ",3,"ngStyle",4,"ngIf"],["style","min-height: 100px; cursor: pointer",3,"ngStyle","click",4,"ngIf"],["style","display: flex; align-items: center; gap: 8px",3,"ngStyle",4,"ngIf"],["style","\n            justify-content: flex-end;\n            display: flex;\n            margin: 3px 0 0 0;\n            font-size: 10px;\n            color: black;\n            display: flex;\n            gap: 10px;\n          ",4,"ngIf"],["style","\n            justify-content: flex-start;\n            align-items: center;\n            display: flex;\n            margin: 3px 0 0 0;\n            font-size: 10px;\n            color: black;\n            display: flex;\n            gap: 10px;\n          ",4,"ngIf"],[2,"border-radius","15px","padding","10px","display","inline-block","max-width","80%","word-break","break-word",3,"ngStyle"],[2,"min-height","100px","cursor","pointer",3,"ngStyle","click"],["alt","Drasti",2,"max-height","200px","border","1px solid #cfcfcf","border-radius","10px","max-width","200px",3,"src"],[2,"display","flex","align-items","center","gap","8px",3,"ngStyle"],["class","fa-regular fa-clock",4,"ngIf"],[1,"rotate-icon","fa-solid","fa-spinner"],["loader",""],["preload","metadata","controls","","controlsList","nodownload noplaybackrate",2,"width","90%","display","none",3,"play","canplaythrough"],["audioPlayer",""],[3,"src"],[1,"fa-regular","fa-clock"],[2,"justify-content","flex-end","display","flex","margin","3px 0 0 0","font-size","10px","color","black","display","flex","gap","10px"],[2,"justify-content","flex-end","display","flex","margin","0","font-size","10px","color","black","font-weight","normal"],[2,"justify-content","flex-start","align-items","center","display","flex","margin","3px 0 0 0","font-size","10px","color","black","display","flex","gap","10px"],[1,"fa-solid","fa-trash",2,"color","red","cursor","pointer","font-size","16px",3,"click"],[2,"justify-content","flex-start","display","flex","margin","0","font-size","10px","color","black","font-weight","normal"],[2,"display","flex","justify-content","center","align-items","center"],[1,"lds-ring"],[3,"micError","send","nowRecording"],[1,"position-relative",2,"height","16px","width","16px"],[1,"fa-solid","fa-image","position-absolute"],["accept","image/*","type","file",2,"position","absolute","top","0","bottom","0","right","0","left","0","width","16px","height","16px","z-index","1","opacity","0",3,"input"],["placeholder","Aa","type","text",3,"keyup.enter"],["msgContent",""],[1,"fa-solid","fa-paper-plane",3,"click"],[1,"locationPopup",2,"display","flex","justify-content","center","align-items","center"],[2,"width","50%","background-color","white","border-radius","8px","padding","16px"],[2,"width","100%","display","flex","justify-content","end","margin-top","20px"],[1,"gotit",2,"background-color","#920f11","color","white",3,"click"],[2,"position","fixed","top","0","bottom","0","right","0","left","0","background-color","black","display","flex","justify-content","center","align-items","center","height","100vh"],[2,"position","relative"],[2,"top","10px","right","10px","position","absolute","display","flex","gap","10px"],[1,"fa-solid","fa-x",2,"background-color","#920f11","padding","10px","border-radius","10px","cursor","pointer","color","white",3,"click"],["alt","",2,"max-width","100%","max-height","100vh",3,"src"],[1,"delete-popup",2,"position","fixed","top","0","bottom","0","left","0","right","0","background-color","rgba(0, 0, 0, 0.5)","display","flex","justify-content","center","align-items","center"],[2,"padding","2rem","text-align","center","background-color","white","border-radius","10px"],[2,"display","flex","justify-content","end","gap","10px"],[1,"btn","btn-danger",3,"disabled","click"],["class","rotate-icon fa-solid fa-spinner",4,"ngIf"],[1,"btn","btn-dark",3,"click"]],template:function(e,n){1&e&&(t.TgZ(0,"div",0)(1,"div",1)(2,"span",2),t._uU(3),t.qZA()(),t.TgZ(4,"div",3,4)(6,"ul",5),t.YNc(7,nt,6,8,"li",6),t.YNc(8,ot,7,0,"li",7),t.qZA()(),t.TgZ(9,"div",8),t.YNc(10,it,2,0,"ng-container",7),t.YNc(11,st,7,0,"ng-container",7),t.qZA()(),t.YNc(12,at,9,0,"div",9),t.YNc(13,rt,5,1,"div",10),t.YNc(14,ct,10,2,"div",11)),2&e&&(t.xp6(3),t.hij("",n.studentName||"\u062f\u0631\u062f\u0634\u0629"," "),t.xp6(4),t.Q6J("ngForOf",n.messages),t.xp6(1),t.Q6J("ngIf",n.imageLoading),t.xp6(2),t.Q6J("ngIf",n.showaudio),t.xp6(1),t.Q6J("ngIf",!n.nowRecording),t.xp6(1),t.Q6J("ngIf",n.micrphonAlert),t.xp6(1),t.Q6J("ngIf",n.currentImage),t.xp6(1),t.Q6J("ngIf",n.selectedMsgToDelete))},directives:[g.sg,g.PC,g.O5,L],pipes:[g.uU],styles:['@charset "UTF-8";.chatbox[_ngcontent-%COMP%]{height:85vh;background-color:#f7fafc;border-radius:10px;display:flex;flex-direction:column}.chatbox[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]{overflow:auto;flex:1}.chatbox[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{flex:1;border-radius:20px;border:none;background-color:#e6e8ec;outline:none;padding:5px 10px}.chatbox[_ngcontent-%COMP%]   .footer[_ngcontent-%COMP%]{gap:8px}.chatbox[_ngcontent-%COMP%]   .footer[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{cursor:pointer;color:#920f11}.locationPopup[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;overflow:auto;background-color:#00000080;z-index:1}.locationPopup[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #d6d4d4;padding:.7rem}.locationPopup[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{cursor:pointer;font-size:1.5rem}.rotate-icon[_ngcontent-%COMP%]{display:inline-block;animation:spin 2s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}']}),o})();function ut(o,s){1&o&&(t.TgZ(0,"h3",11),t._uU(1,"\u0627\u0644\u0637\u0644\u0627\u0628"),t.qZA())}function pt(o,s){1&o&&(t.TgZ(0,"h5",12),t._uU(1,"\u062c\u0627\u0631 \u0627\u0644\u062a\u062d\u0645\u064a\u0644...."),t.qZA())}function mt(o,s){1&o&&t._UZ(0,"span",21)}function gt(o,s){if(1&o){const e=t.EpF();t.TgZ(0,"li",15),t.NdJ("click",function(){t.CHM(e);const i=t.oxw().$implicit;return t.oxw(2).selectStudent(i.userId,i.name)}),t.TgZ(1,"div",16),t._UZ(2,"img",17),t.TgZ(3,"div")(4,"p",18),t._uU(5),t.qZA(),t.TgZ(6,"div",19)(7,"span"),t._uU(8),t.qZA(),t._uU(9," - "),t.TgZ(10,"span"),t._uU(11),t.qZA()()()(),t.YNc(12,mt,1,0,"span",20),t.qZA()}if(2&o){const e=t.oxw().$implicit,n=t.oxw(2);t.Udp("color",e.userId===n.selectedStudentId?"#920f11":"black"),t.xp6(5),t.Oqu(n.materialName),t.xp6(3),t.hij(" ",e.name,""),t.xp6(3),t.Oqu(e.phone),t.xp6(1),t.Q6J("ngIf",e.hasUnread&&n.selectedStudentId!=e.userId)}}function _t(o,s){if(1&o&&(t.ynx(0),t.YNc(1,gt,13,6,"li",14),t.BQk()),2&o){const e=s.$implicit;t.xp6(1),t.Q6J("ngIf",e.phone)}}function ht(o,s){if(1&o&&(t.TgZ(0,"ul"),t.YNc(1,_t,2,1,"ng-container",13),t.qZA()),2&o){const e=t.oxw();t.xp6(1),t.Q6J("ngForOf",e.students)}}function ft(o,s){1&o&&(t.TgZ(0,"h3",12),t._uU(1," \u0644\u0627 \u064a\u0648\u062c\u062f \u0627\u0633\u0626\u0644\u0629 "),t.qZA())}function xt(o,s){if(1&o&&(t.TgZ(0,"div"),t._UZ(1,"app-chat-box",22),t.qZA()),2&o){const e=t.oxw();t.xp6(1),t.Q6J("studentName",e.studentName)("messages",e.messages)}}function Ct(o,s){1&o&&(t.TgZ(0,"h3",24),t._uU(1," \u0642\u0645 \u0628\u0623\u062e\u062a\u064a\u0627\u0631 \u0627\u0644\u0645\u062d\u0627\u062f\u062b\u0629 "),t.qZA())}function yt(o,s){if(1&o&&t.YNc(0,Ct,2,0,"h3",23),2&o){const e=t.oxw();t.Q6J("ngIf",null==e.students?null:e.students.length)}}const vt=[{path:"",component:(()=>{class o{constructor(e,n){this.chatService=e,this.activatedRoute=n,this.materialName="",this.students=[],this.selectedStudentId=null,this.studentName="",this.messages=[],this.loading=!0,this.teacherId=localStorage.getItem("userid")||""}ngOnInit(){this.materialId=this.activatedRoute.snapshot.params.id,this.materialName=this.activatedRoute.snapshot.params.name,this.openChatForStudentID=this.activatedRoute.snapshot.queryParams.studentId,this.openChatForStudentName=this.activatedRoute.snapshot.queryParams.studentNae,this.openChatForStudentID&&this.selectStudent(this.openChatForStudentID,this.openChatForStudentName),console.log(this.openChatForStudentID),this.chatService.listenToChatUsers(this.materialId,this.teacherId,e=>{this.students=e,this.loading=!1})}selectStudent(e,n){this.studentName=n,this.selectedStudentId=e,this.messages=[],setTimeout(()=>{console.log(e),this.chatService.listenToMessages(this.materialId,this.selectedStudentId||"",this.teacherId,i=>{e==this.selectedStudentId&&(console.log("select"),this.messages=i,this.chatService.markMessagesAsRead(this.materialId,e,this.teacherId))})},0)}ngOnDestroy(){this.chatService.stopListeningToMessages()}}return o.\u0275fac=function(e){return new(e||o)(t.Y36(S.a),t.Y36(y.gz))},o.\u0275cmp=t.Xpm({type:o,selectors:[["app-chat-home"]],decls:14,vars:7,consts:[[1,"container","chat-home","mt-3"],[2,"text-align","center","color","#920f11","margin-bottom","20px"],[1,"row"],[1,"col-xl-4","mb-3"],[1,"chat-list"],["style","padding: 16px",4,"ngIf"],["class","text-center",4,"ngIf"],[4,"ngIf"],[1,"col-xl-8"],[4,"ngIf","ngIfElse"],["selectChat",""],[2,"padding","16px"],[1,"text-center"],[4,"ngFor","ngForOf"],["style","\n                border-bottom: 1px solid #d8cfcf;\n                padding: 16px;\n                cursor: pointer;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                font-weight: bold;\n              ","class","mb-2 chat-list-item",3,"color","click",4,"ngIf"],[1,"mb-2","chat-list-item",2,"border-bottom","1px solid #d8cfcf","padding","16px","cursor","pointer","display","flex","justify-content","space-between","align-items","center","font-weight","bold",3,"click"],[2,"display","flex","gap","10px","align-items","center"],["src","assets/logo.png","alt","",2,"width","50px","height","50px","object-fit","cover"],[2,"margin","0"],[2,"display","flex","gap","5px"],["style","\n                  display: block;\n                  width: 10px;\n                  height: 10px;\n                  border-radius: 50%;\n                  background-color: #920f11;\n                ","title","\u0631\u0633\u0627\u0626\u0644 \u063a\u064a\u0631 \u0645\u0642\u0631\u0648\u0621\u0629",4,"ngIf"],["title","\u0631\u0633\u0627\u0626\u0644 \u063a\u064a\u0631 \u0645\u0642\u0631\u0648\u0621\u0629",2,"display","block","width","10px","height","10px","border-radius","50%","background-color","#920f11"],[3,"studentName","messages"],["class","text-center p-5",4,"ngIf"],[1,"text-center","p-5"]],template:function(e,n){if(1&e&&(t.TgZ(0,"section",0)(1,"h1",1),t._uU(2),t.qZA(),t.TgZ(3,"div",2)(4,"div",3)(5,"div",4),t.YNc(6,ut,2,0,"h3",5),t.YNc(7,pt,2,0,"h5",6),t.YNc(8,ht,2,1,"ul",7),t.YNc(9,ft,2,0,"h3",6),t.qZA()(),t.TgZ(10,"div",8),t.YNc(11,xt,2,2,"div",9),t.YNc(12,yt,1,1,"ng-template",null,10,t.W1O),t.qZA()()()),2&e){const i=t.MAs(13);t.xp6(2),t.hij(" \u0627\u0633\u0626\u0644\u0629 \u0645\u0627\u062f\u0629 ",n.materialName," "),t.xp6(4),t.Q6J("ngIf",null==n.students?null:n.students.length),t.xp6(1),t.Q6J("ngIf",n.loading),t.xp6(1),t.Q6J("ngIf",null==n.students?null:n.students.length),t.xp6(1),t.Q6J("ngIf",!(null!=n.students&&n.students.length||n.loading)),t.xp6(2),t.Q6J("ngIf",null==n.messages?null:n.messages.length)("ngIfElse",i)}},directives:[g.O5,g.sg,dt],styles:[".chat-home[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]{list-style:none;padding:0;margin:0}.chat-home[_ngcontent-%COMP%]   .chat-list[_ngcontent-%COMP%]{background-color:#f7fafc;height:85vh;overflow:auto;border-radius:10px}.chat-home[_ngcontent-%COMP%]   .chat-list-item[_ngcontent-%COMP%]:hover{color:#920f11!important}"]}),o})()}];let bt=(()=>{class o{}return o.\u0275fac=function(e){return new(e||o)},o.\u0275mod=t.oAB({type:o}),o.\u0275inj=t.cJS({imports:[[y.Bz.forChild(vt)],y.Bz]}),o})(),wt=(()=>{class o{}return o.\u0275fac=function(e){return new(e||o)},o.\u0275mod=t.oAB({type:o}),o.\u0275inj=t.cJS({imports:[[g.ez,bt,A.JF]]}),o})()}}]);