"use strict";(self.webpackChunkdrasti_teacher_dashboard=self.webpackChunkdrasti_teacher_dashboard||[]).push([[592],{507:(w,b,D)=>{D.d(b,{a:()=>M});var e=D(6197),v=D(5e3);let M=(()=>{class u{constructor(){this.db=(0,e.N8)(),this.messageRef=null}listenToChatUsers(r,f,g){const t=(0,e.iH)(this.db,`Subjects-Messages/${r}`);(0,e.jM)(t,n=>{var d,o;const s=n.val();if(!s)return g([]);const _=[];for(const m in s){const a=Object.values(s[m]),c=a.sort((i,R)=>new Date(i.date).getTime()-new Date(R.date).getTime()),l=c[c.length-1],h=a.some(i=>!1===i.did_read&&i.from_id!==f&&"_1"!==i.from_id);_.push({userId:m,name:(null===(d=c.find(i=>i.from_id!==f&&"_1"!==i.from_id))||void 0===d?void 0:d.from)||"\u0637\u0627\u0644\u0628",phone:(null===(o=c.find(i=>i.from_id!==f&&"_1"!==i.from_id))||void 0===o?void 0:o.from_number)||"",hasUnread:h,lastDate:l.date})}_.sort((m,a)=>new Date(a.lastDate).getTime()-new Date(m.lastDate).getTime()),g(_)})}listenToMessages(r,f,g,t){this.messageRef&&(0,e.S1)(this.messageRef);const n=`Subjects-Messages/${r}/${f}`;this.messageRef=(0,e.iH)(this.db,n);const d=[];(0,e.yv)(this.messageRef,o=>{const s=o.val(),_=o.key;s.from_id!==g&&"_1"!==s.from_id&&!1===s.did_read&&(console.log(n),(0,e.Vx)((0,e.iH)(this.db,`${n}/${_}`),{did_read:!0})),d.push(Object.assign(Object.assign({},s),{key:_}));const m=[...d].sort((a,c)=>new Date(a.date).getTime()-new Date(c.date).getTime());t([...m])})}markMessagesAsRead(r,f,g){const t=`Subjects-Messages/${r}/${f}`,n=(0,e.iH)(this.db,t);(0,e.U2)(n).then(d=>{d.forEach(o=>{const s=o.val();s.from_id!==g&&"_1"!==s.from_id&&!1===s.did_read&&(0,e.Vx)((0,e.iH)(this.db,`${t}/${o.key}`),{did_read:!0})})})}stopListeningToMessages(){this.messageRef&&((0,e.S1)(this.messageRef),this.messageRef=null)}getTeacherChatList(r,f,g){const t=[];r.forEach(n=>{const d=(0,e.iH)(this.db,`Subjects-Messages/${n}`);(0,e.yv)(d,o=>{const s=o.key,_=(0,e.iH)(this.db,`Subjects-Messages/${n}/${s}`);(0,e.yv)(_,m=>{const a=m.val();if(a.to_id==n){const c=!a.did_read&&a.from_id!==f,l=t.findIndex(h=>h.userId===s&&h.materialId===n);if(l>-1){const h=new Date(t[l].lastMessageDate).getTime();new Date(a.date).getTime()>h&&(t[l].lastMessageDate=a.date),t[l].hasUnread=t[l].hasUnread||c}else t.push({materialId:n,materialName:a.material_name,userId:s,userName:a.from,lastMessageDate:a.date,hasUnread:c});t.sort((h,i)=>new Date(i.lastMessageDate).getTime()-new Date(h.lastMessageDate).getTime()),g([...t])}})})})}}return u.\u0275fac=function(r){return new(r||u)},u.\u0275prov=v.Yz7({token:u,factory:u.\u0275fac,providedIn:"root"}),u})()}}]);