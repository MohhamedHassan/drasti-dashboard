"use strict";(self.webpackChunkdrasti_teacher_dashboard=self.webpackChunkdrasti_teacher_dashboard||[]).push([[592],{507:(R,b,D)=>{D.d(b,{a:()=>v});var e=D(6197),M=D(5e3);let v=(()=>{class _{constructor(){this.db=(0,e.N8)(),this.messageRef=null}listenToChatUsers(r,f,g){const t=(0,e.iH)(this.db,`Subjects-Messages/${r}`);(0,e.jM)(t,n=>{var o;const d=n.val();if(!d)return g([]);const s=[];for(const c in d){const h=Object.values(d[c]),i=h.sort((a,u)=>new Date(a.date).getTime()-new Date(u.date).getTime()),l=i[i.length-1],m=h.some(a=>!1===a.did_read&&a.from_id!==f&&"_1"!==a.from_id);s.push({userId:c,name:(null===(o=i.find(a=>a.from_id!==f&&"_1"!==a.from_id))||void 0===o?void 0:o.from)||"\u0637\u0627\u0644\u0628",hasUnread:m,lastDate:l.date})}s.sort((c,h)=>new Date(h.lastDate).getTime()-new Date(c.lastDate).getTime()),g(s)})}listenToMessages(r,f,g,t){this.messageRef&&(0,e.S1)(this.messageRef);const n=`Subjects-Messages/${r}/${f}`;this.messageRef=(0,e.iH)(this.db,n);const o=[];(0,e.yv)(this.messageRef,d=>{const s=d.val(),c=d.key;s.from_id!==g&&"_1"!==s.from_id&&!1===s.did_read&&(console.log(n),(0,e.Vx)((0,e.iH)(this.db,`${n}/${c}`),{did_read:!0})),o.push(Object.assign(Object.assign({},s),{key:c}));const h=[...o].sort((i,l)=>new Date(i.date).getTime()-new Date(l.date).getTime());t([...h])})}markMessagesAsRead(r,f,g){const t=`Subjects-Messages/${r}/${f}`,n=(0,e.iH)(this.db,t);(0,e.U2)(n).then(o=>{o.forEach(d=>{const s=d.val();s.from_id!==g&&"_1"!==s.from_id&&!1===s.did_read&&(0,e.Vx)((0,e.iH)(this.db,`${t}/${d.key}`),{did_read:!0})})})}stopListeningToMessages(){this.messageRef&&((0,e.S1)(this.messageRef),this.messageRef=null)}getTeacherChatList(r,f,g){const t=[];r.forEach(n=>{const o=(0,e.iH)(this.db,`Subjects-Messages/${n}`);(0,e.yv)(o,d=>{const s=d.key,c=(0,e.iH)(this.db,`Subjects-Messages/${n}/${s}`);(0,e.yv)(c,h=>{const i=h.val();if(i.to_id==n){const l=!i.did_read&&i.from_id!==f,m=t.findIndex(a=>a.userId===s&&a.materialId===n);if(m>-1){const a=new Date(t[m].lastMessageDate).getTime();new Date(i.date).getTime()>a&&(t[m].lastMessageDate=i.date),t[m].hasUnread=t[m].hasUnread||l}else t.push({materialId:n,materialName:i.material_name,userId:s,userName:i.from,lastMessageDate:i.date,hasUnread:l});t.sort((a,u)=>new Date(u.lastMessageDate).getTime()-new Date(a.lastMessageDate).getTime()),g([...t])}})})})}}return _.\u0275fac=function(r){return new(r||_)},_.\u0275prov=M.Yz7({token:_,factory:_.\u0275fac,providedIn:"root"}),_})()}}]);